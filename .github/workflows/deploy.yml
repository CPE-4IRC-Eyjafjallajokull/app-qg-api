name: Deploy

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types:
      - completed
    branches: [main]
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
      packages: read
    environment:
      name: PROD
      url: https://${{ vars.API_HOST }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload compose file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ML_DEPLOY_HOST }}
          username: ${{ secrets.ML_DEPLOY_USER }}
          key: ${{ secrets.ML_DEPLOY_KEY }}
          port: ${{ secrets.ML_DEPLOY_PORT }}
          source: "compose.prod.yaml"
          target: "/opt/mathislambert.fr/applications/app-qg-api"

      - name: Remote deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          APP_NAME: ${{ vars.APP_NAME || 'app-qg-api' }}
          APP_ENVIRONMENT: ${{ vars.APP_ENVIRONMENT || 'production' }}
          APP_LOG_LEVEL: ${{ vars.APP_LOG_LEVEL || 'INFO' }}
          APP_POSTGRES_DSN: ${{ secrets.APP_POSTGRES_DSN }}
          APP_RABBITMQ_DSN: ${{ secrets.APP_RABBITMQ_DSN }}
          API_HOST: ${{ vars.API_HOST }}
        with:
          host: ${{ secrets.ML_DEPLOY_HOST }}
          username: ${{ secrets.ML_DEPLOY_USER }}
          key: ${{ secrets.ML_DEPLOY_KEY }}
          port: ${{ secrets.ML_DEPLOY_PORT }}
          script_stop: true
          envs: GITHUB_REF_NAME,APP_NAME,APP_ENVIRONMENT,APP_LOG_LEVEL,APP_POSTGRES_DSN,APP_RABBITMQ_DSN,API_HOST
          script: |
            set -euo pipefail
            OWNER='${{ github.repository_owner }}'
            TAG="$GITHUB_REF_NAME"
            INSTALL_DIR=/opt/mathislambert.fr/applications/app-qg-api
            OWNER_LC=$(printf '%s' "$OWNER" | tr '[:upper:]' '[:lower:]')

            # Ensure networks exist
            docker network create proxy || true
            docker network create databases || true
            docker network create monitor || true

            # Login to GHCR
            if [ -n '${{ secrets.GITHUB_TOKEN }}' ]; then
              printf '%s' '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin
            fi

            # Set default values
            APP_NAME=${APP_NAME:-app-qg-api}
            APP_ENVIRONMENT=${APP_ENVIRONMENT:-production}
            APP_LOG_LEVEL=${APP_LOG_LEVEL:-INFO}
            API_HOST=${API_HOST:-api.example.com}

            cd "$INSTALL_DIR"
            
            # Pull latest image
            OWNER="$OWNER_LC" IMAGE_TAG="$TAG" docker compose -f compose.prod.yaml pull

            # Deploy with environment variables
            OWNER="$OWNER_LC" IMAGE_TAG="$TAG" \
              APP_NAME="$APP_NAME" \
              APP_ENVIRONMENT="$APP_ENVIRONMENT" \
              APP_LOG_LEVEL="$APP_LOG_LEVEL" \
              APP_POSTGRES_DSN="$APP_POSTGRES_DSN" \
              APP_RABBITMQ_DSN="$APP_RABBITMQ_DSN" \
              API_HOST="$API_HOST" \
              docker compose -f compose.prod.yaml up -d --remove-orphans

            # Cleanup old images
            docker image prune -f || true

            echo "âœ… Deployment completed successfully!"
            echo "ðŸš€ API available at: https://$API_HOST"
