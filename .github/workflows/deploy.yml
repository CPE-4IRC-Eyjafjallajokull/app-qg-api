name: Deploy

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types:
      - completed
    branches: [main]
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
      packages: read
    environment:
      name: PROD
      url: https://${{ vars.API_HOST }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for image to propagate to GHCR
        run: |
          echo "‚è≥ Waiting 30 seconds for image to propagate to GHCR..."
          sleep 30
          echo "‚úÖ Ready to deploy!"

      - name: Upload compose file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ML_DEPLOY_HOST }}
          username: ${{ secrets.ML_DEPLOY_USER }}
          key: ${{ secrets.ML_DEPLOY_KEY }}
          port: ${{ secrets.ML_DEPLOY_PORT }}
          source: "compose.prod.yaml"
          target: "/opt/mathislambert.fr/applications/app-qg-api"

      - name: Remote deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          APP_VERSION: ${{ github.ref_name || github.sha }}
          API_HOST: ${{ vars.API_HOST }}
          APP_NAME: ${{ vars.APP_NAME || 'app-qg-api' }}
          APP_ENVIRONMENT: ${{ vars.APP_ENVIRONMENT || 'production' }}
          APP_LOG_LEVEL: ${{ vars.APP_LOG_LEVEL || 'INFO' }}
          APP_LOG_FORMAT: ${{ vars.APP_LOG_FORMAT || 'json' }}
          APP_DEBUG: ${{ vars.APP_DEBUG || 'false' }}
          APP_CORS_ORIGINS: ${{ vars.APP_CORS_ORIGINS || '*' }}
          APP_EVENTS_PING_INTERVAL_SECONDS: ${{ vars.APP_EVENTS_PING_INTERVAL_SECONDS || '25' }}
          AUTH_DISABLED: ${{ vars.AUTH_DISABLED || 'false' }}
          KEYCLOAK_SERVER_URL: ${{ vars.KEYCLOAK_SERVER_URL || 'http://localhost:8080' }}
          KEYCLOAK_REALM: ${{ vars.KEYCLOAK_REALM || 'master' }}
          KEYCLOAK_CLIENT_ID: ${{ vars.KEYCLOAK_CLIENT_ID || 'app-qg-api' }}
          KEYCLOAK_AUDIENCE: ${{ vars.KEYCLOAK_AUDIENCE || vars.KEYCLOAK_CLIENT_ID || 'app-qg-api' }}
          KEYCLOAK_CACHE_TTL_SECONDS: ${{ vars.KEYCLOAK_CACHE_TTL_SECONDS || '300' }}
          KEYCLOAK_TIMEOUT_SECONDS: ${{ vars.KEYCLOAK_TIMEOUT_SECONDS || '3.0' }}
          POSTGRES_DSN: ${{ secrets.POSTGRES_DSN }}
          RABBITMQ_DSN: ${{ secrets.RABBITMQ_DSN }}
          NOMINATIM_BASE_URL: ${{ vars.NOMINATIM_BASE_URL || 'https://nominatim.openstreetmap.org' }}
          NOMINATIM_TIMEOUT_SECONDS: ${{ vars.NOMINATIM_TIMEOUT_SECONDS || '4.0' }}
          NOMINATIM_USER_AGENT: ${{ vars.NOMINATIM_USER_AGENT || '' }}
          NOMINATIM_ACCEPT_LANGUAGE: ${{ vars.NOMINATIM_ACCEPT_LANGUAGE || 'fr' }}
          NOMINATIM_CACHE_TTL_SECONDS: ${{ vars.NOMINATIM_CACHE_TTL_SECONDS || '600' }}
          NOMINATIM_THROTTLE_SECONDS: ${{ vars.NOMINATIM_THROTTLE_SECONDS || '1.0' }}
          NOMINATIM_CACHE_ROUNDING_PRECISION: ${{ vars.NOMINATIM_CACHE_ROUNDING_PRECISION || '5' }}
        with:
          host: ${{ secrets.ML_DEPLOY_HOST }}
          username: ${{ secrets.ML_DEPLOY_USER }}
          key: ${{ secrets.ML_DEPLOY_KEY }}
          port: ${{ secrets.ML_DEPLOY_PORT }}
          script_stop: true
          envs: GITHUB_REF_NAME,API_HOST,APP_VERSION,APP_NAME,APP_ENVIRONMENT,APP_LOG_LEVEL,APP_LOG_FORMAT,APP_DEBUG,APP_CORS_ORIGINS,APP_EVENTS_PING_INTERVAL_SECONDS,AUTH_DISABLED,KEYCLOAK_SERVER_URL,KEYCLOAK_REALM,KEYCLOAK_CLIENT_ID,KEYCLOAK_AUDIENCE,KEYCLOAK_CACHE_TTL_SECONDS,KEYCLOAK_TIMEOUT_SECONDS,POSTGRES_DSN,RABBITMQ_DSN,NOMINATIM_BASE_URL,NOMINATIM_TIMEOUT_SECONDS,NOMINATIM_USER_AGENT,NOMINATIM_ACCEPT_LANGUAGE,NOMINATIM_CACHE_TTL_SECONDS,NOMINATIM_THROTTLE_SECONDS,NOMINATIM_CACHE_ROUNDING_PRECISION
          script: |
            set -euo pipefail
            OWNER='${{ github.repository_owner }}'
            TAG="$GITHUB_REF_NAME"
            INSTALL_DIR=/opt/mathislambert.fr/applications/app-qg-api
            OWNER_LC=$(printf '%s' "$OWNER" | tr '[:upper:]' '[:lower:]')

            # Ensure networks exist
            docker network create proxy || true
            docker network create databases || true
            docker network create monitor || true

            # Login to GHCR
            if [ -n '${{ secrets.GITHUB_TOKEN }}' ]; then
              printf '%s' '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin
            fi

            # Set default values
            APP_VERSION=${APP_VERSION:-latest}
            APP_NAME=${APP_NAME:-app-qg-api}
            APP_ENVIRONMENT=${APP_ENVIRONMENT:-production}
            APP_LOG_LEVEL=${APP_LOG_LEVEL:-INFO}
            APP_LOG_FORMAT=${APP_LOG_FORMAT:-json}
            APP_DEBUG=${APP_DEBUG:-false}
            APP_CORS_ORIGINS=${APP_CORS_ORIGINS:-*}
            APP_EVENTS_PING_INTERVAL_SECONDS=${APP_EVENTS_PING_INTERVAL_SECONDS:-25}
            API_HOST=${API_HOST:-api.example.com}
            AUTH_DISABLED=${AUTH_DISABLED:-false}
            KEYCLOAK_SERVER_URL=${KEYCLOAK_SERVER_URL:-http://localhost:8080}
            KEYCLOAK_REALM=${KEYCLOAK_REALM:-master}
            KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-app-qg-api}
            KEYCLOAK_AUDIENCE=${KEYCLOAK_AUDIENCE:-$KEYCLOAK_CLIENT_ID}
            KEYCLOAK_CACHE_TTL_SECONDS=${KEYCLOAK_CACHE_TTL_SECONDS:-300}
            KEYCLOAK_TIMEOUT_SECONDS=${KEYCLOAK_TIMEOUT_SECONDS:-3.0}
            POSTGRES_DSN=${POSTGRES_DSN:-}
            RABBITMQ_DSN=${RABBITMQ_DSN:-}
            NOMINATIM_BASE_URL=${NOMINATIM_BASE_URL:-https://nominatim.openstreetmap.org}
            NOMINATIM_TIMEOUT_SECONDS=${NOMINATIM_TIMEOUT_SECONDS:-4.0}
            NOMINATIM_USER_AGENT=${NOMINATIM_USER_AGENT:-}
            NOMINATIM_ACCEPT_LANGUAGE=${NOMINATIM_ACCEPT_LANGUAGE:-fr}
            NOMINATIM_CACHE_TTL_SECONDS=${NOMINATIM_CACHE_TTL_SECONDS:-600}
            NOMINATIM_THROTTLE_SECONDS=${NOMINATIM_THROTTLE_SECONDS:-1.0}
            NOMINATIM_CACHE_ROUNDING_PRECISION=${NOMINATIM_CACHE_ROUNDING_PRECISION:-5}

            cd "$INSTALL_DIR"
            
            # Pull latest image
            OWNER="$OWNER_LC" IMAGE_TAG="$TAG" docker compose -f compose.prod.yaml pull

            # Deploy with environment variables
            OWNER="$OWNER_LC" IMAGE_TAG="$TAG" \
              APP_VERSION="$APP_VERSION" \
              APP_NAME="$APP_NAME" \
              APP_ENVIRONMENT="$APP_ENVIRONMENT" \
              APP_LOG_LEVEL="$APP_LOG_LEVEL" \
              APP_LOG_FORMAT="$APP_LOG_FORMAT" \
              APP_DEBUG="$APP_DEBUG" \
              APP_CORS_ORIGINS="$APP_CORS_ORIGINS" \
              APP_EVENTS_PING_INTERVAL_SECONDS="$APP_EVENTS_PING_INTERVAL_SECONDS" \
              AUTH_DISABLED="$AUTH_DISABLED" \
              POSTGRES_DSN="$POSTGRES_DSN" \
              RABBITMQ_DSN="$RABBITMQ_DSN" \
              KEYCLOAK_SERVER_URL="$KEYCLOAK_SERVER_URL" \
              KEYCLOAK_REALM="$KEYCLOAK_REALM" \
              KEYCLOAK_CLIENT_ID="$KEYCLOAK_CLIENT_ID" \
              KEYCLOAK_AUDIENCE="$KEYCLOAK_AUDIENCE" \
              KEYCLOAK_CACHE_TTL_SECONDS="$KEYCLOAK_CACHE_TTL_SECONDS" \
              KEYCLOAK_TIMEOUT_SECONDS="$KEYCLOAK_TIMEOUT_SECONDS" \
              NOMINATIM_BASE_URL="$NOMINATIM_BASE_URL" \
              NOMINATIM_TIMEOUT_SECONDS="$NOMINATIM_TIMEOUT_SECONDS" \
              NOMINATIM_USER_AGENT="$NOMINATIM_USER_AGENT" \
              NOMINATIM_ACCEPT_LANGUAGE="$NOMINATIM_ACCEPT_LANGUAGE" \
              NOMINATIM_CACHE_TTL_SECONDS="$NOMINATIM_CACHE_TTL_SECONDS" \
              NOMINATIM_THROTTLE_SECONDS="$NOMINATIM_THROTTLE_SECONDS" \
              NOMINATIM_CACHE_ROUNDING_PRECISION="$NOMINATIM_CACHE_ROUNDING_PRECISION" \
              API_HOST="$API_HOST" \
              docker compose -f compose.prod.yaml up -d --remove-orphans

            # Cleanup old images
            docker image prune -f || true

            echo "‚úÖ Deployment completed successfully!"
            echo "üöÄ API available at: https://$API_HOST"
