name: OWASP ZAP DAST

on:
  push:
    branches: [main]

  pull_request:
    branches: [main]

  schedule:
    - cron: "0 3 * * 2"

  workflow_dispatch:

jobs:
  zap-scan:
    name: Scan DAST OWASP ZAP
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      issues: write
      security-events: write

    steps:
      - name: Checkout du d√©p√¥t
        uses: actions/checkout@v4

      - name: D√©tection de docker-compose.yml
        id: check-compose
        run: |
          if [ -f "docker-compose.yml" ]; then
            echo "compose_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ docker-compose.yml d√©tect√© - build avec Docker"
          else
            echo "compose_exists=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Pas de docker-compose.yml - build avec uv"
          fi

      - name: D√©marrage avec Docker Compose
        if: steps.check-compose.outputs.compose_exists == 'true'
        run: |
          cat > .env << EOF
          APP_ENVIRONMENT=production
          APP_DEBUG=false
          APP_LOG_LEVEL=INFO
          POSTGRES_DSN=postgresql+asyncpg://postgres:postgres@postgres:5432/app
          RABBITMQ_DSN=amqp://guest:guest@rabbitmq:5672/
          EOF

          docker compose up -d

          echo "‚è≥ Attente du d√©marrage de l'application..."
          sleep 20

      - name: Installation de Python 3.12
        if: steps.check-compose.outputs.compose_exists == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Installation de uv
        if: steps.check-compose.outputs.compose_exists == 'false'
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Installation des d√©pendances
        if: steps.check-compose.outputs.compose_exists == 'false'
        run: uv sync

      - name: D√©marrage de l'API FastAPI
        if: steps.check-compose.outputs.compose_exists == 'false'
        run: |
          uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          echo $! > .api.pid
          echo "‚è≥ Attente du d√©marrage de l'application..."
          sleep 15
        env:
          APP_ENVIRONMENT: production
          APP_DEBUG: false
          APP_LOG_LEVEL: INFO

      - name: V√©rification de la disponibilit√© (http://localhost:8000)
        run: |
          echo "üîç Test de connexion √† l'API..."
          timeout 90 bash -c '
            until curl -f -s -o /dev/null http://localhost:8000/health; do
              echo "En attente de http://localhost:8000/health..."
              sleep 3
            done
          '
          echo "‚úÖ API FastAPI disponible sur http://localhost:8000"

      - name: OWASP ZAP - API Scan
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: zaproxy/action-api-scan@v0.9.0
        with:
          target: "http://localhost:8000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j -l WARN"
          issue_title: "ZAP API Scan - R√©sultats de s√©curit√©"
          fail_action: false
          artifact_name: "zap-api-scan"

      - name: OWASP ZAP - Full Scan
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: "http://localhost:8000"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j -l WARN"
          issue_title: "ZAP Full Scan - R√©sultats de s√©curit√©"
          fail_action: false
          artifact_name: "zap-full-scan"

      - name: Fail on ZAP High alerts
        if: always()
        run: |
          set -eo pipefail
          if [ ! -f report_json.json ]; then
            echo "‚ö†Ô∏è report_json.json introuvable ‚Äî v√©rification ignor√©e"
            exit 0
          fi
          command -v jq >/dev/null 2>&1 || { echo "Installation de jq..."; sudo apt-get update && sudo apt-get install -y jq; }
          high_count=$(jq '[.site[]?.alerts[]? | select((.risk // "") | ascii_upcase == "HIGH")] | length' report_json.json)
          if [ "$high_count" -gt 0 ]; then
            echo "‚ùå ZAP a d√©tect√© $high_count alerte(s) de s√©v√©rit√© High. D√©tails :"
            jq -r '.site[]?.alerts[]? | select((.risk // "") | ascii_upcase == "HIGH") | "- \(.name) | risk:\(.risk) | confidence:\(.confidence) | url:\(.url) | param:\(.param) | evidence:\(.evidence // \"N/A\")"' report_json.json || true
            exit 1
          else
            echo "‚úÖ Aucune alerte High d√©tect√©e par ZAP."
          fi

      - name: Sauvegarde des rapports ZAP
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-reports
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30
          if-no-files-found: warn

      - name: Arr√™t de l'application (Docker Compose)
        if: always() && steps.check-compose.outputs.compose_exists == 'true'
        run: docker compose down

      - name: Arr√™t de l'application (uv)
        if: always() && steps.check-compose.outputs.compose_exists == 'false'
        run: |
          if [ -f .api.pid ]; then
            kill $(cat .api.pid) || true
            rm .api.pid
          fi

      - name: Cr√©ation d'issue GitHub pour les alertes critiques
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('report_md.md')) {
              const report = fs.readFileSync('report_md.md', 'utf8');
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üö® ZAP DAST - Vuln√©rabilit√©s d√©tect√©es',
                body: `## üîí Rapport de scan OWASP ZAP\n\n${report}\n\n---\n\n**üìÖ Date du scan :** ${new Date().toISOString()}\n**üåø Branche :** \`${context.ref}\`\n**üîó Workflow :** [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                labels: ['security', 'zap-dast', 'vulnerability']
              });
              core.info('‚úÖ Issue GitHub cr√©√©e avec les r√©sultats du scan');
            } else {
              core.warning('‚ö†Ô∏è Aucun rapport ZAP trouv√©');
            }
